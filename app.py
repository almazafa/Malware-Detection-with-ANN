from flask import Flask, request, render_template
from werkzeug.utils import secure_filename
import pandas as pd
from tensorflow.keras.models import load_model
import os
import math

app = Flask(__name__)
model = load_model('C:\\Users\\project18\\PycharmProjects\\pythonProject\\mymodel3.h5')
UPLOAD_FOLDER="C:\\Users\\project18\\PycharmProjects\\pythonProject\\upload"
ALLOWED_EXTENSIONS = {'csv'}
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

@app.route('/')
def form():
    return render_template("index.html")

@app.route('/', methods=["POST","GET"])
def transform_view():
    f = request.files['csvfile']
    #if f.rsplit('.', 1)[1].lower() == 'csv':
        #return "no file"
    if not f:
        return render_template("index.html")

       # return "No file"
    # save the file in 'upload' folder

    filename = secure_filename(f.filename)
    if filename.rsplit('.', 1)[1].lower() == 'csv':
        file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        print(file_path)
        f.save(file_path)
    else:
        print("Please upload csv file")
        errormsg="Please upload csv file"
        return render_template("index.html",errormsg=errormsg)
    print("1st")
    if os.stat(file_path).st_size > 5:
    # load the model from disk
        model=load_model('C:\\Users\\project18\\PycharmProjects\\pythonProject\\mymodel3.h5')
        df = pd.read_csv(file_path,header=None)
        print("ok")
        if len(df.index) == 1:
            if len(df.columns) == 73:
    #model.compile(optimizer="adam", loss="binary_crossentropy", metrics=['accuracy'], run_eagerly=True)
                print("ok2")
                annfile = model.predict(df)
    #response =((annfile[0,0])*100)
                response=(math.ceil((annfile[0,0]) * 100))
    #response = round((annfile[0,0])*100)
                print(response)
                return render_template("index.html",prediction=response)
            else:
                print("please upload csv with 73 columns")
                errmsg1="Please upload csv file with 73 columns"
                return render_template("index.html",errmsg1=errmsg1)
        else:
            print("please upload csv with 1 row")
            errmsg3 = "Please upload csv file with 1 row"
            return render_template("index.html", errmsg3=errmsg3)
    else:
        print("hey")
        errmsg2="please upload csv file with 73 columns"
        return render_template("index.html", errmsg2=errmsg2)


@app.route('/about')
def about():
    return render_template('about.html')

@app.route('/ShowGraphics')
def ShowGraphics():
    return render_template('ShowGraphics.html')
@app.route('/ShowStatistics')
def ShowStatistics():
    return render_template('ShowStatistics.html')


if __name__ == "__main__":
    app.run(debug=True)